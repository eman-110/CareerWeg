<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Courses</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .grid-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      align-items: center;
      padding: 15px 20px;
      gap: 10px;
    }

    .table-header {
      font-weight: bold;
      background-color: #eef0ff;
      color: #000042;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .course-row {
      background-color: #fff;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .status.complete {
      color: #00b894;
      font-weight: 500;
    }

    .cert-btn {
      background-color: #00b894;
      color: #fff;
      padding: 8px 20px;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
    }

    iframe {
      width: 100%;
      border: none;
    }

    #header-frame {
      height: 70px;
    }

    #footer-frame {
      height: 410px;
    }
  </style>
</head>
<body>
  <iframe id="header-frame" src="../../header-main.html"></iframe>

  <div class="dashboard">
    <aside class="sidebar">
      <h3>CANDIDATE DASHBOARD</h3>
      <nav class="sidebar-nav">
        <a href="../employeedashboard/dashboard.html" class="nav-item">
          <img src="../../assets/img/profile.png" alt="Profile Icon" />
          <span>Profile</span>
        </a>
        <a href="../joblisting/employeeJobListing.html" class="nav-item">
          <img src="../../assets/img/jobs.png" alt="Job Listing Icon" />
          <span>Applied Jobs</span>
        </a>
        <a href="../My Courses Complete/index.html" class="nav-item1">
          <img src="../../assets/img/My Courses.png" alt="My Courses Icon" />
          <span>My Courses</span>
        </a>
      </nav>
      <a href="../../BeforeLogin/HomePageBeforeLogin/homePageBeforeLogin.html" class="logout">
        <img src="../../assets/img/logout.png" alt="Logout Icon" />
        <span>Log-out</span>
      </a>
    </aside>

    <div class="content">
      <h1>My Courses</h1>

      <div class="tabs">
        <a href="../My Courses In Progress/index.html" class="tab inactive">In Progress</a>
        <a href="../My Courses Complete/index.html" class="tab active">Complete</a>
      </div>

      <!-- Header Row -->
      <div class="table-header grid-row">
        <div>Courses</div>
        <div>Status</div>
        <div>Completion Date</div>
        <div>Action</div>
      </div>

      <!-- Injected Course Rows -->
      <div class="course-form" id="complete-course-list"></div>
    </div>
  </div>

  <iframe id="footer-frame" src="../../footer-main.html"></iframe>

  <script>
    function loadCompletedCourses() {
      fetch("/api/enrollments/my-courses")
        .then(response => {
          if (!response.ok) throw new Error("Failed to fetch courses");
          return response.json();
        })
        .then(courses => {
          const list = document.getElementById("complete-course-list");
          const completed = courses.filter(c => c.status === "Complete");

          if (completed.length === 0) {
            list.innerHTML = "<p>No completed courses yet.</p>";
            return;
          }

          // Fetch user info once
          fetch("/api/users/me")
            .then(res => res.json())
            .then(user => {
              completed.forEach(course => {
                const row = document.createElement("div");
                row.className = "course-row grid-row";
                const formattedDate = formatDate(course.enrollmentDate);
                const encodedParams = new URLSearchParams({
                  name: user.firstName + " " + user.lastName,
                  course: course.courseName,
                  date: formattedDate
                }).toString();

                row.innerHTML = `
                  <div><strong>${course.courseName}</strong></div>
                  <div class="status complete">${course.status}</div>
                  <div>${formattedDate}</div>
                  <div>
                    <button type="button" class="cert-btn"
                      onclick="window.location.href='../CertificateofCompletion/certificate.html?${encodedParams}'">
                      Certificate
                    </button>
                  </div>
                `;
                list.appendChild(row);
              });
            });
        })
        .catch(err => {
          console.error("Error loading completed courses:", err);
          document.getElementById("complete-course-list").innerHTML = "<p>Error loading data.</p>";
        });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-US", {
        year: "numeric", month: "long", day: "numeric"
      });
    }

    document.addEventListener("DOMContentLoaded", loadCompletedCourses);
  </script>
</body>
</html>
